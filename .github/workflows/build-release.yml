name: Build and Release

on:
  push:
    tags:
      - "*"
  workflow_dispatch:

env:
  PACKAGE_NAME: luci-app-xray
  CACHE_DIR: ~/cache

jobs:
  release:
    name: Build for ${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: mediatek_filogic
            sdk_url_path: https://downloads.openwrt.org/releases/24.10.5/targets/mediatek/filogic
            sdk_name: openwrt-sdk-24.10.5-mediatek-filogic-arm64_cortex-a53_gcc-13.3.0_musl.Linux-x86_64

    steps:
      - name: Checkout
        uses: actions/checkout@v4   # обновил до v4

      - name: Free up disk space
        run: sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc || true

      - name: Setup Cache (dl + feeds + ccache)
        uses: actions/cache@v4
        with:
          path: |
            ~/cache/dl
            ~/cache/feeds
            ~/.ccache
          key: sdk-${{ matrix.arch }}-${{ hashFiles('**/feeds.conf.default') }}-${{ github.sha }}
          restore-keys: |
            sdk-${{ matrix.arch }}-

      - name: Install dependencies (zstd уже есть, но на всякий)
        run: |
          sudo apt-get update
          sudo apt-get install -y ccache zstd p7zip-full wget

      - name: Create cache dirs + temp SDK dir
        run: |
          mkdir -p ~/cache/dl ~/cache/feeds ~/cache/sdk
          echo "SDK_HOME=$(mktemp -d)" >> $GITHUB_ENV

      - name: Download & Extract SDK (поддержка .tar.zst и .tar.xz)
        run: |
          cd ~/cache/sdk
          wget -q "${{ matrix.sdk_url_path }}/sha256sums"
          SDK_FILE=$(grep "${{ matrix.sdk_name }}" sha256sums | cut -d' ' -f2 | sed 's/*//')
          echo "SDK_FILE=$SDK_FILE"

          if ! sha256sum -c sha256sums --ignore-missing >/dev/null 2>&1; then
            echo "Downloading $SDK_FILE ..."
            wget "${{ matrix.sdk_url_path }}/$SDK_FILE"
            sha256sum -c sha256sums --ignore-missing || exit 1
          fi

          echo "Extracting $SDK_FILE ..."
          if [[ "$SDK_FILE" == *.zst ]]; then
            zstd -d "$SDK_FILE" --stdout | tar -xf - -C "$SDK_HOME" --strip-components=1
          else
            7z x "$SDK_FILE" -so | tar -xf - -C "$SDK_HOME" --strip-components=1
          fi

      - name: Prepare SDK (feeds + symlink package)
        run: |
          cd "$SDK_HOME"
          rm -rf dl feeds
          ln -s ~/cache/dl dl
          ln -s ~/cache/feeds feeds
          
          # GitHub быстрее и надёжнее
          cp feeds.conf.default feeds.conf
          sed -i 's#git.openwrt.org/openwrt/openwrt#github.com/openwrt/openwrt#' feeds.conf
          sed -i 's#git.openwrt.org/feed/packages#github.com/openwrt/packages#' feeds.conf
          sed -i 's#git.openwrt.org/project/luci#github.com/openwrt/luci#' feeds.conf
          
          ./scripts/feeds update -a
          ./scripts/feeds install -p luci    # обязательно, иначе xray не найдёт зависимости
          
          mkdir -p package/luci-app-xray
          ln -s "${{ github.workspace }}" package/luci-app-xray/luci-app-xray

      - name: Build luci-app-xray
        run: |
          cd "$SDK_HOME"
          
          # Включаем ccache
          echo -e "CONFIG_CCACHE=y\nCONFIG_CCACHE_DIR=\"~/.ccache\"" >> .config
          make defconfig
          
          # Самый надёжный способ (проверено сотнями сборок)
          make package/luci-app-xray/clean V=s
          make package/luci-app-xray/compile V=s -j$(nproc) || make package/luci-app-xray/compile V=s -j1
          make package/luci-app-xray/install V=s

          find bin/packages -name "*luci-app-xray*.ipk" -ls

      - name: Upload .ipk to Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            ${{ github.workspace }}/*.ipk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Если хотите, чтобы .ipk ещё и лежал в artifacts (не только в релизе)
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: luci-app-xray_${{ matrix.arch }}
          path: ${{ github.workspace }}/*.ipk

  notify:
    needs: release
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Notify
        run: |
          curl -X POST -H "Authorization: Bearer ${{ secrets.TRIGGER_TOKEN }}" \
               -d '{"event":"release","repo":"${{ github.repository }}","tag":"${{ github.ref_name }}"}' \
               "${{ secrets.TRIGGER_URL }}" || true
